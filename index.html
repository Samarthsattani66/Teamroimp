<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Willow Live Events Player</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        #loading {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-size: 1.5em;
        }
        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #player-container {
            height: 100%;
            width: 100%;
        }
        iframe {
            border: none;
            width: 100%;
            height: 100%;
        }
        #error {
            color: red;
            text-align: center;
            padding: 20px;
            display: none;
        }
        #status {
            margin-top: 20px;
            font-size: 0.8em;
            color: #666;
        }
    </style>
</head>
<body>
    <div id="loading">
        <div class="spinner"></div>
        <div>Loading live stream...</div>
        <div id="status"></div>
    </div>
    <div id="error"></div>
    <div id="player-container"></div>

    <script>
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
            console.log(message);
        }

        document.addEventListener('DOMContentLoaded', function() {
            updateStatus('Initializing player...');
            
            // First try to play directly from a known good URL (for testing)
            const testStream = getTestStream();
            if (testStream) {
                updateStatus('Trying test stream...');
                playStream(testStream.url, testStream.key);
                return;
            }

            updateStatus('Fetching live events data...');
            fetch('https://raw.githubusercontent.com/drmlive/willow-live-events/main/willow.json')
                .then(response => {
                    if (!response.ok) throw new Error('Network response failed');
                    return response.json();
                })
                .then(data => {
                    updateStatus('Processing match data...');
                    if (!data.matches || data.matches.length === 0) {
                        throw new Error('No matches available');
                    }

                    // Find the first live or upcoming match
                    const now = new Date();
                    const liveMatch = data.matches.find(match => {
                        if (!match.startTime) return false;
                        const startTime = new Date(match.startTime);
                        const endTime = new Date(startTime.getTime() + 8 * 60 * 60 * 1000); // Assume 8hr duration
                        return now >= startTime && now <= endTime;
                    });

                    if (!liveMatch) {
                        throw new Error('No live matches currently available');
                    }

                    updateStatus(`Found match: ${liveMatch.title}`);
                    
                    if (!liveMatch.playback_data || !liveMatch.playback_data.urls || liveMatch.playback_data.urls.length === 0) {
                        throw new Error('No stream URLs available');
                    }

                    // Find the best quality stream
                    const streams = liveMatch.playback_data.urls
                        .filter(urlObj => urlObj.url && (
                            urlObj.url.includes('.mpd') || 
                            urlObj.url.includes('mpd?') ||
                            urlObj.url.includes('/mpd')
                        ))
                        .sort((a, b) => {
                            // Prioritize certain CDNs
                            const aPriority = a.url.includes('cloudfront.net') ? 2 : 
                                            a.url.includes('akamaized.net') ? 1 : 0;
                            const bPriority = b.url.includes('cloudfront.net') ? 2 : 
                                            b.url.includes('akamaized.net') ? 1 : 0;
                            return bPriority - aPriority;
                        });

                    if (streams.length === 0) {
                        throw new Error('No valid stream formats found');
                    }

                    const streamUrl = streams[0].url;
                    const streamKey = liveMatch.playback_data.keys?.[0] || '';
                    
                    updateStatus(`Attempting to play: ${streamUrl}`);
                    playStream(streamUrl, streamKey);
                })
                .catch(error => {
                    updateStatus(`Error: ${error.message}`);
                    showError(error.message);
                    playFallbackContent();
                });
        });

        function getTestStream() {
            // For testing - replace with a known working URL if available
            return null;
            
            /* Example format:
            return {
                url: 'https://example.com/stream.mpd',
                key: 'abcdef1234567890'
            };
            */
        }

        function playStream(url, key) {
            updateStatus(`Preparing player for: ${url}`);
            
            // Create a video element directly instead of iframe for better control
            const container = document.getElementById('player-container');
            container.innerHTML = `
                <video id="videoPlayer" controls autoplay style="width:100%;height:100%">
                    Your browser does not support HTML5 video
                </video>
            `;
            
            const video = document.getElementById('videoPlayer');
            
            // Try with Shaka Player for better DRM support
            if (typeof shaka !== 'undefined') {
                updateStatus('Using Shaka Player');
                const player = new shaka.Player(video);
                
                player.configure({
                    drm: {
                        servers: {
                            'com.widevine.alpha': 'https://license.example.com/getkey' // Replace with actual license server if needed
                        }
                    }
                });
                
                player.load(url).then(() => {
                    updateStatus('Shaka Player loaded successfully');
                    document.getElementById('loading').style.display = 'none';
                }).catch(error => {
                    updateStatus(`Shaka Player error: ${error.message}`);
                    tryBasicPlayback(url);
                });
            } else {
                tryBasicPlayback(url);
            }
        }

        function tryBasicPlayback(url) {
            updateStatus('Trying basic HTML5 playback');
            const video = document.getElementById('videoPlayer');
            
            video.src = url;
            video.load();
            
            video.onerror = function() {
                updateStatus(`Video error: ${video.error.message}`);
                showError('Could not play the video stream');
                playFallbackContent();
            };
            
            video.onplaying = function() {
                updateStatus('Video playback started');
                document.getElementById('loading').style.display = 'none';
            };
            
            video.onstalled = function() {
                updateStatus('Video stalled - buffering');
            };
            
            video.onwaiting = function() {
                updateStatus('Video waiting for data');
            };
        }

        function playFallbackContent() {
            updateStatus('Loading fallback content');
            const container = document.getElementById('player-container');
            container.innerHTML = `
                <div style="display:flex; flex-direction:column; justify-content:center; align-items:center; height:100%; text-align:center; padding:20px;">
                    <h2>Stream Not Available</h2>
                    <p>We couldn't load the live stream. Please try again later.</p>
                    <button onclick="window.location.reload()" style="padding:10px 20px; background:#3498db; color:white; border:none; border-radius:5px; cursor:pointer;">
                        Retry
                    </button>
                </div>
            `;
            document.getElementById('loading').style.display = 'none';
        }

        function showError(message) {
            document.getElementById('error').textContent = message;
            document.getElementById('error').style.display = 'block';
        }

        // Load Shaka Player if needed
        if (typeof shaka === 'undefined') {
            updateStatus('Loading Shaka Player library...');
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.7/shaka-player.compiled.js';
            script.onload = function() {
                shaka.polyfill.installAll();
                updateStatus('Shaka Player loaded');
            };
            script.onerror = function() {
                updateStatus('Failed to load Shaka Player - using basic player');
            };
            document.head.appendChild(script);
        }
    </script>
</body>
</html>
